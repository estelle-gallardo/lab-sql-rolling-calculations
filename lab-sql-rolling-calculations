-- 1. Get number of monthly active customers.
create or replace view VW_USER_RENTALS as (
	select C.CUSTOMER_ID, R.RENTAL_ID, DATE_FORMAT(convert(R.RENTAL_DATE, DATE), '%m') as RENTAL_MONTH, DATE_FORMAT(convert(R.RENTAL_DATE, DATE), '%Y') as RENTAL_YEAR
	from RENTAL R 
	join CUSTOMER C 
	on C.CUSTOMER_ID = R.CUSTOMER_ID);

create or replace view VW_USER_ACTIVITY as (
	select COUNT(VW_UR.CUSTOMER_ID) as ACTIVE_CUSTOMERS, VW_UR.RENTAL_MONTH, VW_UR.RENTAL_YEAR 
	from VW_USER_RENTALS VW_UR
	group by 2, 3
	order by 3, 2);

select *
from VW_USER_ACTIVITY;

-- 2. Active users in the previous month.
with CTE_ACTIVE_USERS as (
	select VW_UA.RENTAL_YEAR, VW_UA.RENTAL_MONTH, VW_UA.ACTIVE_CUSTOMERS,
		LAG(ACTIVE_CUSTOMERS, 1) over (order by RENTAL_YEAR, RENTAL_MONTH) as ACTIVE_CUSTOMERS_LAST_MONTH
	from VW_USER_ACTIVITY VW_UA
)
select CTE.*, (CTE.ACTIVE_CUSTOMERS - CTE.ACTIVE_CUSTOMERS_LAST_MONTH) as DIFFERENCE
from CTE_ACTIVE_USERS CTE ;

-- 3. Percentage change in the number of active customers.
with CTE_ACTIVE_USERS as (
	select VW_UA.RENTAL_YEAR, VW_UA.RENTAL_MONTH, VW_UA.ACTIVE_CUSTOMERS,
		LAG(ACTIVE_CUSTOMERS, 1) over (order by RENTAL_YEAR, RENTAL_MONTH) as ACTIVE_CUSTOMERS_LAST_MONTH
	from VW_USER_ACTIVITY VW_UA
)
select CTE.*, (CTE.ACTIVE_CUSTOMERS - CTE.ACTIVE_CUSTOMERS_LAST_MONTH) as DIFFERENCE, CONCAT(convert(ROUND((CTE.ACTIVE_CUSTOMERS - CTE.ACTIVE_CUSTOMERS_LAST_MONTH)/CTE.ACTIVE_CUSTOMERS_LAST_MONTH * 100, 2), NCHAR), '%') as PERCENTAGE
from CTE_ACTIVE_USERS CTE 
where CTE.ACTIVE_CUSTOMERS_LAST_MONTH is not null;

-- 4. Retained customers every month.
create or replace view VW_DISTINCT_CUSTOMERS as 
select distinct UR.CUSTOMER_ID as ACTIVE_ID, UR.RENTAL_YEAR, UR.RENTAL_MONTH
from VW_USER_RENTALS UR;

create or replace view RETAINED_CUSTOMERS as 
select VW1.RENTAL_YEAR, VW1.RENTAL_MONTH, COUNT(distinct VW1.ACTIVE_ID) as RETAINED_CUSTOMERS
from VW_DISTINCT_CUSTOMERS VW1
join VW_DISTINCT_CUSTOMERS VW2
on VW1.ACTIVE_ID = VW2.ACTIVE_ID
where VW2.RENTAL_MONTH = VW1.RENTAL_MONTH + 1
group by VW1.RENTAL_YEAR, VW1.RENTAL_MONTH;

select * 
from RETAINED_CUSTOMERS;
